name: Weekly OTBR Build

on:
  schedule:
    - cron: '0 0 * * 0' # Weekly on Sunday at midnight
  workflow_dispatch: # Allow manual trigger

jobs:
  build:
    name: Build OTBR for ${{ matrix.target }}/${{ matrix.subtarget }}
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: rockchip
            subtarget: armv8
          - target: x86
            subtarget: 64
          - target: amlogic
            subtarget: meson64
          - target: ramips
            subtarget: mt7621

    steps:
      - name: Checkout iStoreOS
        uses: actions/checkout@v4
        with:
          repository: istoreos/istoreos
          ref: istoreos-24.10
          path: istoreos

      - name: Checkout OTBR
        uses: actions/checkout@v4
        with:
          repository: openthread/ot-br-posix
          path: ot-br-posix

      - name: Initialization environment
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential clang flex bison g++ gawk gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev python3-distutils python3-pyelftools python3-setuptools rsync unzip zlib1g-dev file wget swig

      - name: Update and Install Feeds
        run: |
          cd istoreos
          echo "src-link openthread ../ot-br-posix/etc/openwrt" >> feeds.conf.default
          ./scripts/feeds update -a
          ./scripts/feeds install -a
          ./scripts/feeds install openthread-br

      - name: Configure and Compile
        run: |
          cd istoreos
          # Create a minimal .config for the target
          echo "CONFIG_TARGET_${{ matrix.target }}=y" > .config
          echo "CONFIG_TARGET_${{ matrix.target }}_${{ matrix.subtarget }}=y" >> .config
          
          # Select openthread-br and its dependencies
          echo "CONFIG_PACKAGE_openthread-br=y" >> .config
          echo "CONFIG_PACKAGE_ot-br-posix-web=y" >> .config
          
          # Expand the config to include dependencies
          make defconfig
          
          # Compile the package
          make package/openthread-br/compile V=s -j$(nproc)

      - name: Organize Files
        run: |
          mkdir -p bin/packages/${{ matrix.target }}/${{ matrix.subtarget }}
          find istoreos/bin/packages/ -name "openthread-br*.ipk" -exec cp {} bin/packages/${{ matrix.target }}/${{ matrix.subtarget }}/ \;
          find istoreos/bin/packages/ -name "ot-br-posix-web*.ipk" -exec cp {} bin/packages/${{ matrix.target }}/${{ matrix.subtarget }}/ \;

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: otbr-${{ matrix.target }}-${{ matrix.subtarget }}
          path: bin/packages/

  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Organize Release Files
        run: |
          mkdir release
          find artifacts -name "*.ipk" -exec cp {} release/ \;

      - name: Generate Release Tag
        id: tag
        run: echo "release_tag=$(date +'%Y.%m.%d')" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.tag.outputs.release_tag }}
          name: OTBR Build ${{ steps.tag.outputs.release_tag }}
          files: release/*.ipk
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}